(function(n){"use strict";const C=Object.prototype.hasOwnProperty;function L(o,t){return C.call(o,t)}function b(){function o(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}const t=o()+o(),e=o(),s=(parseInt(o(),16)&4095|16384).toString(16),r=(parseInt(o(),16)&16383|32768).toString(16),i=o()+o()+o();return`${t}-${e}-${s}-${r}-${i}`}function y(o){let t=o.tagName.toLowerCase(),e="";return t==="select"?e=o.options[o.selectedIndex].innerText:L(o,"inputmask")?e=o.inputmask.undoValue:o.getAttribute("type")=="date"?o.value&&(e=new Date(...o.value.split("-")).toLocaleDateString()):o.getAttribute("type")=="checkbox"?e=o.checked?"on":"off":e=o.value,e}function M(o){return Number(o)}function E(){window.hasOwnProperty("calculatedFields")&&calculatedFields.forEach(function(o){o.executeAll()})}function v(){window.hasOwnProperty("calculatedFields")&&window.calculatedFields.forEach(function(o){let t=o.field,e=t.getAttribute("id");document.querySelector("td[data-source='"+e+"']")&&(t.hasAttribute("data-event")||(t.addEventListener("oncalculate",function(){let r=y(t),i=document.querySelector("td[data-source='"+e+"']");i&&(i.innerText=r)}),t.setAttribute("data-event",!0)))})}function q(o){for(;o.hasChildNodes();)o.removeChild(o.lastChild)}function I(){const o=`
    .cfm-selection-border {
        position: absolute;
        top: 0px;
        bottom: 0px;
        left: 0px;
        width: 0.150rem;
        background-color: rgb(220 53 69 / 1);
    }
    .cfm-modal-backdrop {
        position: fixed;
        inset: 0px;
        z-index: 100;
        background-color: rgb(31 41 55 / 1);
        opacity: 0;
        transition-property: opacity;
        transition-duration: 300ms;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    }
    .cfm-opacity-50 {
        opacity: 0.5;
    }
    .cfm-opacity-100 {
        opacity: 1;
    }
    .cfm-tr.selected{
      background-color: rgba(0, 0, 0, 0.08) !important;
    }
    .cfm .modal-body {
      max-height: calc(100vh - 150px);
      overflow-x: auto;
    }
    `,t=document.createElement("style");t.innerHTML=o,document.head.appendChild(t)}function F(o,t){return t.some(e=>e.id===o)?t.find(e=>e.id===o):!1}function B(o){document.readyState!=="loading"?o():document.addEventListener("DOMContentLoaded",o)}const p="formset";class g{constructor(t,e){var s=this;this.opts=n.extend({},g.defaults,e),this.$formset=n(t),this.$formset.attr("data-uuid",b()),this.$emptyForm=this.$formset.find(this.opts.emptyForm),this.$body=this.$formset.find(this.opts.body),this.$add=this.$formset.find(this.opts.add),this.formsetPrefix=n(t).data("formset-prefix"),this.addForm=n.proxy(this,"addForm"),this.$add.click(this.addForm),this.$formset.on("formAdded formDeleted",this.opts.form,n.proxy(this,"checkMaxForms")),this.$forms().each(function(i,a){n(a),s.bindForm(n(this),i)}),this.$formset.data(p,this);var r=["animateForms"];n.each(r,function(i,a){a in s.opts&&s.opts[a]&&s[a]()})}static getOrCreate(t,e){var s=n(t).data(p);return s||(s=new g(t,e)),s}addForm(){if(this.hasMaxForms())throw new Error("MAX_NUM_FORMS reached");var t=this.totalFormCount();this.$managementForm("TOTAL_FORMS").val(t+1);var e=this.$emptyForm.html().replace(new RegExp("__prefix__","g"),t).replace(new RegExp("<\\\\/script>","g"),"<\/script>"),s=n(n.parseHTML(e,this.$body.document,!0));this.$body.append(s);var r=s.filter(this.opts.form);return this.bindForm(r,t),this.opts.newFormCallback&&this.opts.newFormCallback(r),r}bindForm(t,e){var s=this.formsetPrefix+"-"+e;t.data(p+"__formPrefix",s);var r=t.find("[name="+s+"-DELETE]");r.change(function(a){r.is(":checked")?(t.attr("data-formset-form-deleted",""),t.find(":required").data(p+"-required-field",!0).prop("required",!1),t.find("input[pattern]").each(function(){var l=n(this).attr("pattern");n(this).data(p+"-field-pattern",l).removeAttr("pattern")}),t.trigger("formDeleted")):(t.removeAttr("data-formset-form-deleted"),t.find("*").filter(function(){return n(this).data(p+"-required-field")===!0}).prop("required",!0),t.find("input").each(function(){var l=n(this).data(p+"-field-pattern");l&&n(this).attr("pattern",l)}),t.trigger("formAdded"))}).trigger("change");var i=t.find(this.opts.deleteButton);i.bind("click",function(){r.attr("checked",!0).change()})}$forms(){return this.$body.find(this.opts.form)}$managementForm(t){return this.$formset.find("[name="+this.formsetPrefix+"-"+t+"]")}totalFormCount(){return this.$forms().length}deletedFormCount(){return this.$forms().filter("[data-formset-form-deleted]").length}clear(){this.$forms().each(function(t,e){n(e).find(":input").not(":button, :submit, :reset, :hidden, :checkbox, :radio").val("")})}deleteAll(){this.$forms().each(function(t,e){n(e).find("[deletecheckbox]").prop("checked",!0).change()})}activeFormCount(){return this.totalFormCount()-this.deletedFormCount()}openRownum(){var t=this.$formset.find("tr.row-open").attr("data-rownum");return typeof t!=null?parseInt(t):0}hasMaxForms(){var t=parseInt(this.$managementForm("MAX_NUM_FORMS").val(),10)||1e3;return this.activeFormCount()>=t}checkMaxForms(){this.hasMaxForms()?(this.$formset.addClass(this.opts.hasMaxFormsClass),this.$add.attr("disabled","disabled")):(this.$formset.removeClass(this.opts.hasMaxFormsClass),this.$add.removeAttr("disabled"))}animateForms(){this.$formset.on("formAdded",this.opts.form,function(){var t=n(this);t.slideUp(0),t.slideDown()}).on("formDeleted",this.opts.form,function(){var t=n(this);t.slideUp()}),this.$forms().filter("[data-formset-form-deleted]").slideUp(0)}}g.defaults={form:"[data-formset-form]",emptyForm:"script[type=form-template][data-formset-empty-form]",body:"[data-formset-body]",add:"[data-formset-add]",deleteButton:"[data-formset-delete-button]",hasMaxFormsClass:"has-max-forms",animateForms:!1,newFormCallback:!1};const k={sm:"modal-sm",md:"modal-md",lg:"modal-lg",xl:"modal-xl"},w={bootstrap4:{sizes:k},bootstrap5:{sizes:k}},T={placement:"center",size:"md",backdropClasses:"cfm-modal-backdrop",templatePack:null,onHide:()=>{},onShow:()=>{},onToggle:()=>{}};class x{constructor(t=null,e={}){this._targetEl=t,this._parentEl=t.parentElement,this._options={...T,...e},this._isHidden=!0,this._init(),this._addEventListeners()}_init(){this._getPlacementClasses().map(t=>{this._targetEl.classList.add(t)}),this._clearSize(),this._getSizeClasses().map(t=>{this._targetEl.firstElementChild.classList.add(t)})}_createBackdrop(t){if(this._isHidden){const e=document.createElement("div");e.setAttribute("data-ref-id",t),e.setAttribute("modal-backdrop",""),e.classList.add(...this._options.backdropClasses.split(" ")),this._parentEl.append(e),e.offsetWidth,e.classList.add("cfm-opacity-50")}}_destroyBackdropEl(){if(!this._isHidden){let t=this._targetEl.getAttribute("data-ref-id");document.querySelector(`[modal-backdrop][data-ref-id="${t}"]`).remove()}}_getPlacementClasses(){switch(this._options.placement){case"top-left":return["justify-content-start","align-items-start"];case"top-center":return["justify-content-center","align-items-start"];case"top-right":return["justify-content-end","align-items-start"];case"center-left":return["justify-content-start","align-items-center"];case"center":return["justify-content-center","align-items-center"];case"center-right":return["justify-content-end","align-items-center"];case"bottom-left":return["justify-content-start","align-items-end"];case"bottom-center":return["justify-content-center","align-items-end"];case"bottom-right":return["justify-content-end","align-items-end"];default:return["justify-content-center","align-items-center"]}}_getSizeClasses(){return w[this._options.templatePack].sizes[this._options.size].split(" ")}_clearSize(){const t=this._targetEl.firstElementChild,e=w[this._options.templatePack].sizes;for(const s in e)e.hasOwnProperty(s)&&t.classList.remove(e[s])}_addEventListeners(){let t=this;this._targetEl.addEventListener("keyup",function(e){e.key==="Escape"&&t.hide()})}toggle(){this._isHidden?this.show():this.hide(),this._options.onToggle(this)}show(){const t=b();this._targetEl.classList.add("d-flex"),this._targetEl.classList.remove("d-none"),this._targetEl.setAttribute("aria-modal","true"),this._targetEl.setAttribute("role","dialog"),this._targetEl.removeAttribute("aria-hidden"),this._targetEl.setAttribute("data-ref-id",t),this._createBackdrop(t),this._isHidden=!1,document.body.classList.add("modal-open"),this._options.onShow(this);let e=this._targetEl.querySelector('select, input:not([type="hidden"]');e&&(e.setAttribute("tabindex","0"),e.focus()),this._targetEl.offsetWidth,this._targetEl.classList.add("cfm-opacity-100")}hide(){this._targetEl.classList.add("d-none"),this._targetEl.classList.remove("d-flex"),this._targetEl.setAttribute("aria-hidden","true"),this._targetEl.removeAttribute("aria-modal"),this._targetEl.removeAttribute("role"),this._destroyBackdropEl(),this._isHidden=!0,document.body.classList.remove("modal-open"),this._options.onHide(this)}}const z={parent:null,modalId:null,onKeyUp:function(){},onClose:function(){},onOpen:function(){}};class P{constructor(t,e={}){this.targetEl=t,this._options={...z,...e},this.modalId=this._options.modalId,this._modalEl=null,this._modalTitleEl=null,this._modalDeleteBt=null,this.modalInstance=!1,this.rownum=null,this._init(),this._addEvents()}_init(){this._modalEl=document.getElementById(this.modalId),this._modalTitleEl=this._modalEl.querySelector(".modal-title"),this._modalDeleteBt=this._modalEl.querySelector(".formset-delete"),this._createModal()}_addEvents(){let t=this;this._modalEl.querySelectorAll('[data-formset-modal-toggle="'+this.modalId+'"]').forEach(function(e){e.addEventListener("click",function(){t.close()})})}hasFieldError(t){let e=this.targetEl.querySelector(`#div_${t}`),s=!1,r="";return e.querySelectorAll(".field-error").forEach(function(i){s=!0,r=i.innerText}),{error:s,text:r}}hasNonFieldError(){return this.targetEl.querySelector(".non-field-errors")!=null}_hiddeDefaultDeleteBt(t){t.parentNode.classList.add("d-none")}_createModal(){let t=this;if(!this.modalInstance){let e=this.targetEl.querySelector(".formset-delete"),s=new x(this._modalEl,{placement:t._options.placement,size:t._options.size,templatePack:t._options.templatePack,onHide:function(r){t._onModalClose(r)},onShow:function(r){t._onModalShow(r)}});s._targetEl.addEventListener("keyup",function(r){t._options.onKeyUp(r,t)}),this.modalInstance=s,this._hiddeDefaultDeleteBt(e)}}_onModalShow(t){this._options.onOpen(this);let s=this._options.parent.targetEl.querySelector(".btn-open-row[data-formset-modal-toggle='"+this.modalId+"']").closest("tr");this._modalTitleEl.innerText="Editing row #"+this.rownum,s.classList.add("row-open")}_onModalClose(t){this._options.onClose(this);let e=this._options.parent.targetEl.querySelector(".btn-open-row[data-formset-modal-toggle='"+this.modalId+"']");e&&e.closest("tr").classList.remove("row-open")}isDeleted(){return this.targetEl.hasAttribute("data-formset-form-deleted")}isSelected(){return this.targetEl.hasAttribute("data-formset-form-selected")}open(){this.modalInstance.show()}close(){this.modalInstance.hide()}}const _={tabular:"tabular",stacked:"stacked",modal:"modal"},D={checkboxClasses:"checkbox",selectionMarkClasses:"cfm-selection-border",tdClasses:"cfm-td",trClasses:"cfm-tr",editText:"Editar",pencilIcon:`
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16">
    <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
</svg>
`};class O{constructor(t){this._id=t,this.targetEl=document.getElementById(this._id),this.variant=_.tabular,this.$formset=null,this._options={...D},this._modalForms=[],this._deleteBt=null,this._table=null,this._tbody=null,this._tfoot=null,this._init(),this._addEvents()}_init(){this.variant=this._getVariant(),this.templatePack=this._getTemplatePack(),this.modalSize=this._getModalSize(),this.modalPlacement=this._getModalPlacement(),this.$formset=n(`#${this._id}`),this.$formset.formset({animateForms:!0}),(this.variant===_.modal||this.variant==_.tabular)&&(this._table=this.targetEl.querySelector("table"),this._tbody=this._table.querySelector("tbody"),this._tfoot=this._table.querySelector("tfoot")),this.variant===_.modal&&(this._deleteBt=this.targetEl.querySelector(".delete-selected"),this._checkInitials(),this._configureSelectAllToggler(),this._refresh())}_getVariant(){return this.targetEl.getAttribute("data-formset-variant")}_getTemplatePack(){return this.targetEl.getAttribute("data-template-pack")}_getModalSize(){return this.targetEl.getAttribute("data-modal-size")}_getModalPlacement(){return this.targetEl.getAttribute("data-modal-placement")}_getModalFormInstanceByRownum(t){let e=!1;return this._modalForms.forEach(function(s){s.rownum===t&&!s.isDeleted()&&(e=s)}),e}_addEvents(){let t=this;this.$formset.on("formAdded",function(e){t._onFormsetAdded(e)}),this.$formset.on("formDeleted",function(e){t._onFormsetDeleted(e)})}_checkInitials(){let t=this,e=[];this.targetEl.querySelectorAll("[data-formset-modal-toggle]").forEach(function(s){let r=s.closest("[data-formset-form]"),i=s.getAttribute("data-formset-modal-toggle");e.includes(i)||t._newModalForm(r,i),e.push(i)})}_newModalForm(t,e){let s=this,r={parent:s,modalId:e,size:this.modalSize,placement:this.modalPlacement,templatePack:s.templatePack,onKeyUp:function(a,l){s._onModalFormKeyUp(a,l)},onOpen:function(a){s._onModalFormOpen(a)},onClose:function(a){s._onModalFormClose(a)}},i=new P(t,r);return s._modalForms.push(i),i}_onFormsetAdded(t){if(this.variant===_.modal){let e=b();n(this.targetEl).find("#__dialog_id__").attr("id",e),n(this.targetEl).find('[data-formset-modal-toggle="__dialog_id__"]').attr("data-formset-modal-toggle",e),this._newModalForm(t.target,e).open()}window.hasOwnProperty("calculatedFields")&&(window.resetCalculatedFields(),v())}_onFormsetDeleted(){this.variant==_.modal&&this._refresh(),E()}_onModalFormKeyUp(t,e){if(t.ctrlKey&&(t.keyCode===38||t.keyCode===40)){t.preventDefault();let s=e.rownum,r=this.$formset.formset("getOrCreate"),i=r.activeFormCount();t.keyCode==38&&s>1&&(e.close(),this._getModalFormInstanceByRownum(s-1).open()),t.keyCode===40&&(s<i&&(e.close(),this._getModalFormInstanceByRownum(s+1).open()),s==i&&(e.close(),r.addForm()))}}_onModalFormOpen(t){this._refresh()}_onModalFormClose(t){this._refresh()}_configureSelectAllToggler(){let t=this,e=this._table,s=this.targetEl.querySelector(".select-all"),r=this.targetEl.querySelector(".delete-selected");s.addEventListener("change",function(i){let a=s.checked;e.querySelectorAll(".select-row").forEach(function(m){let d=m.closest("tr"),h=m.closest("td"),S=d.querySelector("[data-formset-modal-toggle]").getAttribute("data-formset-modal-toggle"),f=document.getElementById(S).closest("[data-formset-form]");m.checked=a,t._checker(d,h,f,m)})}),r.addEventListener("click",function(i){t.targetEl.querySelectorAll("[data-formset-form-selected]").forEach(function(m){let d=m.querySelector(".formset-delete");d.checked=!0,d.dispatchEvent(new Event("change"))})})}_checkSelectAllState(){let t=this._table,s=this.targetEl.querySelector(".delete-selected"),r=!1,i=t.querySelector(".select-all"),a=t.querySelectorAll("tbody tr").length,l=t.querySelectorAll("tr.selected").length;l===a&&a>0?(i.checked=!0,i.indeterminate=!1,r=!0):(l!=a&&l>0&&(i.indeterminate=!0,i.checked=!1,r=!0),l===0&&(i.checked=!1,i.indeterminate=!1,r=!1)),r?(s.classList.remove("d-none"),s.classList.add("d-inline-flex")):(s.classList.remove("d-inline-flex"),s.classList.add("d-none"))}_checker(t,e,s,r){let i=e.querySelector(".cfm-selection-border");if(i&&i.remove(),r.checked){let a=document.createElement("div");e.classList.add("position-relative"),a.classList.add(...this._options.selectionMarkClasses.split(" ")),e.prepend(a),s.setAttribute("data-formset-form-selected","selected"),t.classList.add("selected")}else r.classList.remove("position-relative"),t.classList.remove("selected"),s.removeAttribute("data-formset-form-selected");this._checkSelectAllState()}_getEmptyStateHtml(t){let e=`
        <tr class="empty-table">
            <td class="empty-table-content text-center" colspan=__colspan__>
                Sin datos     
            </td>
        </tr>
        `;return e=e.replace("__colspan__",t),e}_refresh(){let t=this,e={},s=[],r=[];this._table.querySelectorAll("[data-field-name]").forEach(function(a){e[a.getAttribute("data-field-name")]={type:a.getAttribute("data-field-type"),hasSummary:a.hasAttribute("data-field-summary"),summary:0}}),s=Object.keys(e),this._modalForms.forEach(function(a){if(!a.isDeleted()){let l={};a.targetEl.querySelectorAll("input, select").forEach(function(m){let d=m.name.match(/(?<form>\w+)-(?<number>\w+)-(?<name>\w+)/);if(d){let h=d.groups.name;if(s.includes(h)){let u=y(m);l[h]={value:u,sourceId:m.getAttribute("id")},l.modalForm=a}}}),r.push(l)}}),q(this._tbody),r.length===0&&(this._tbody.innerHTML=this._getEmptyStateHtml(s.length+3));let i=1;r.forEach(function(a){a.modalForm.rownum=i;let l=document.createElement("tr");l.classList.add(...t._options.trClasses.split(" ")),l.setAttribute("data-rownum",i),a.modalForm.hasNonFieldError()&&(l.style="border: 1px solid #ff4545");let m=document.createElement("td"),d=document.createElement("input");d.setAttribute("type","checkbox"),d.classList.add(...t._options.checkboxClasses.split(" ")),d.classList.add("select-row"),m.appendChild(d),d.addEventListener("change",function(c){t._checker(l,m,a.modalForm.targetEl,c.target)}),l.appendChild(m);let h=document.createElement("td");h.classList.add(...t._options.tdClasses.split(" ")),h.classList.add("w-10"),h.classList.add("text-right"),h.classList.add("cursor-pointer"),h.innerText=i,h.addEventListener("click",function(){a.modalForm.open()}),l.appendChild(h),s.forEach(function(c){let f=document.createElement("td"),A=a.modalForm.hasFieldError(a[c].sourceId);f.classList.add(...t._options.tdClasses.split(" ")),A.error&&(f.style="border: 1px solid #ff4545",f.title=A.text),e[c].type==="bool"?(checked=a[c].value==="on"?"checked":"",f.innerHTML=`<input type="checkbox" class="${t._options.checkboxClasses}" ${checked} disabled></input>`):f.innerText=a[c].value,e[c].type==="numeric"&&(f.classList.add("text-right"),e[c].hasSummary&&(e[c].summary=e[c].summary+M(a[c].value))),(e[c].type==="bool"||e[c].type=="date")&&f.classList.add("text-center"),f.setAttribute("data-source",a[c].sourceId),l.appendChild(f)});let u=document.createElement("td");u.classList.add(...t._options.tdClasses.split(" ")),u.classList.add("w-16"),u.classList.add("text-center"),u.classList.add("p-0"),u.classList.add("align-middle"),u.innerHTML=`
                <button title="${t._options.editText}" 
                        class="btn-open-row btn btn-sm btn btn-primary"
                        data-formset-modal-toggle="${a.modalForm.modalId}">
                        ${t._options.pencilIcon}
                </button>`,u.querySelector(".btn-open-row").addEventListener("click",function(c){a.modalForm.open()}),l.appendChild(u),t._tbody.appendChild(l),a.modalForm.isSelected()&&(d.checked=!0,t._checker(l,m,a.modalForm.targetEl,d)),i++}),this._tfoot&&this._tfoot.querySelectorAll("[data-summary-column]").forEach(function(a){let l=e[a.getAttribute("data-summary-column")].summary;a.innerText=l}),this._checkSelectAllState()}}function H(){document.querySelectorAll(".formset").forEach(function(t){new O(t.getAttribute("id"))})}function R(){let o=[];document.querySelectorAll("[data-modal-toggle]").forEach(t=>{const e=t.getAttribute("data-modal-toggle"),s=document.getElementById(e),r=s.getAttribute("data-modal-placement");s&&!s.hasAttribute("aria-hidden")&&!s.hasAttribute("aria-modal")&&s.setAttribute("aria-hidden","true");let i=null;F(e,o)?(i=F(e,o),i=i.object):(i=new x(s,{placement:r||Default.placement}),o.push({id:e,object:i})),s.hasAttribute("data-modal-show")&&s.getAttribute("data-modal-show")==="true"&&i.show(),t.addEventListener("click",()=>{i.toggle()})})}n.fn[p]=function(){var o,t,e;if(arguments.length===0||arguments.length===1&&n.type(arguments[0])!="string")return o=arguments[0],this.each(function(){return g.getOrCreate(this,o)});if(t=arguments[0],e=n.makeArray(arguments).slice(1),t in g)return e.unshift(this),g[t].apply(g,e);throw new Error("Unknown function call "+t+" for $.fn.formset")},B(function(){I(),R(),v(),H(),E()})})($);
//# sourceMappingURL=crispy-formset-modal.min.js.map
